import kivy
from kivy.app import App
from kivy.uix.label import Label
from kivy.uix.floatlayout import FloatLayout
from kivy.uix.anchorlayout import AnchorLayout
from kivy.uix.textinput import TextInput
from kivy.uix.button import Button
from kivy.uix.spinner import Spinner
from kivy.core.window import Window
import numpy as np
from scipy.optimize import fmin_slsqp

kivy.require('1.9.0')


R = 8.314e-3  # kJ/mol/K

P = 10.0  # atm, this is the total pressure in the reactor
Po = 1.0  # atm, this is the standard state pressure

species = ['CO', 'H2O', 'CO2', 'H2', 'CH4', 'O2']

# Heats of formation at 298.15 K


lab1 = Label(size_hint=(.2, .1),
             pos_hint={'top': .4, 'right': .6},
             text='Results',
             font_size=30)

lab2 = Label(size_hint=(.2, .1),
             pos_hint={'top': 0.87, 'right': .6},
             text='Pressure (atm)',
             font_size=15)
lab3 = Label(size_hint=(.2, .1),
             pos_hint={'top': 0.77, 'right': .35},
             text='fuel (mole)',
             font_size=15)
lab4 = Label(size_hint=(.2, .1),
             pos_hint={'top': 0.77, 'right': .85},
             text='oxidant (mole)',
             font_size=15)

text_box1 = TextInput(size_hint=(.98, .3),
                      pos_hint={'top': .305, 'right': 0.99},
                      text='',
                      multiline=True)

text_box2 = TextInput(size_hint=(.98, .04),
                      pos_hint={'top': .8, 'right': 0.99},
                      text='10',
                      multiline=False)
text_box3 = TextInput(size_hint=(.48, .04),
                      pos_hint={'top': .7, 'right': 0.49},
                      text='1',
                      multiline=False)
text_box4 = TextInput(size_hint=(.48, .04),
                      pos_hint={'top': .7, 'right': 0.99},
                      text='1',
                      multiline=False)

spinner1 = Spinner(size_hint=(.2, .06),
                   pos_hint={'top': .6, 'right': .4},
                   # default value shown
                   text='H2(L)',
                   # available values
                   values=('H2(L)', 'CH4'))

spinner2 = Spinner(size_hint=(.2, .06),
                   pos_hint={'top': .6, 'right': .8},
                   # default value shown
                   text='O2(L)',
                   # available values
                   values=('O2(L)', 'N2O'))


# if T < 700: #           A          B           C          D          E            F          G       H WB = [[
# 25.56759,   6.096130,  4.054656,  -2.671301,  0.131021, -118.0089, 227.3665,  -110.5271],   # CO [30.09200,
# 6.832514,  6.793435,  -2.534480,  0.082139, -250.8810, 223.3967,  -241.8264],   # H2O [24.99735,   55.18696,
# -33.69137,   7.948387, -0.136638, -403.6075, 228.2431,  -393.5224],   # CO2 [33.066178, -11.363417, 11.432816,
# -2.772874, -0.158558, -9.980797, 172.707974, 0.0],        # H2 [-0.703029,  108.4773, -42.52157,   5.862788,
# 0.678565, -76.84376, 158.7163,  -74.87310],   # CH4 [31.32234,  -20.23531,  57.86644,  -36.50624, -0.007374,
# -8.903471, 246.7945,   0.0]]        # O2 else: if T < 1000: #           A          B           C          D
# E         F         G          H WB = [[25.56759,   6.096130,  4.054656,  -2.671301,  0.131021, -118.0089,
# 227.3665,  -110.5271],   # CO [30.09200,   6.832514,  6.793435,  -2.534480,  0.082139, -250.8810, 223.3967,
# -241.8264],   # H2O [24.99735,   55.18696, -33.69137,   7.948387, -0.136638, -403.6075, 228.2431,  -393.5224],
# CO2 [33.066178, -11.363417, 11.432816, -2.772874, -0.158558, -9.980797, 172.707974, 0.0],        # H2 [-0.703029,
# 108.4773, -42.52157,   5.862788,  0.678565, -76.84376, 158.7163,  -74.87310],   # CH4 [30.03235,   8.772972,
# -3.988133,   0.788313, -0.741599, -11.32468, 236.1663,   0.0]]        # O2* else: if T < 1200: #           A
# B           C          D          E          F         G         H WB = [[25.56759,   6.096130,   4.054656,
# -2.671301,  0.131021, -118.0089, 227.3665,  -110.5271],   # CO [30.09200,   6.832514,   6.793435,  -2.534480,
# 0.082139, -250.8810, 223.3967,  -241.8264],   # H2O [24.99735,   55.18696,  -33.69137,   7.948387, -0.136638,
# -403.6075, 228.2431,  -393.5224],   # CO2 [18.563083,  12.257357, -2.859786,   0.268238,  1.977990, -1.147438,
# 156.288133, 0.0],        # H2* [-0.703029,  108.4773,  -42.52157,   5.862788,  0.678565, -76.84376, 158.7163,
# -74.87310],   # CH4 [30.03235,   8.772972,  -3.988133,   0.788313, -0.741599, -11.32468, 236.1663,   0.0]]        #
# O2 else: if T < 1300: #           A         B          C         D         E          F          G           H WB =
# [[25.56759,  6.096130,   4.054656, -2.671301,  0.131021, -118.0089, 227.3665,  -110.5271],  # CO [30.09200,
# 6.832514,   6.793435, -2.534480,  0.082139, -250.8810, 223.3967,  -241.8264],  # H2O [58.16639,  2.720074,
# -0.492289,  0.038844, -6.447293, -425.9186, 263.6125,  -393.5224],  # CO2* [18.563083, 12.257357, -2.859786,
# 0.268238,  1.977990, -1.147438, 156.288133, 0.0],       # H2 [-0.703029, 108.4773,  -42.52157,  5.862788,
# 0.678565, -76.84376, 158.7163,  -74.87310],  # CH4 [30.03235,  8.772972,  -3.988133,  0.788313, -0.741599,
# -11.32468, 236.1663,   0.0]]       # O2 else: if T < 1700: #           A         B          C         D         E
# F          G           H WB = [[35.15070,  1.300095,  -0.205921,  0.013550, -3.282780, -127.8375, 231.7120,
# -110.5271],   # CO* [30.09200,  6.832514,   6.793435, -2.534480,  0.082139, -250.8810, 223.3967,  -241.8264],
# H2O [58.16639,  2.720074,  -0.492289,  0.038844, -6.447293, -425.9186, 263.6125,  -393.5224],   # CO2 [18.563083,
# 12.257357, -2.859786,  0.268238,  1.977990, -1.147438, 156.288133, 0.0],        # H2 [-0.703029, 108.4773,
# -42.52157,  5.862788,  0.678565, -76.84376, 158.7163,  -74.87310],   # CH4 [30.03235,  8.772972,  -3.988133,
# 0.788313, -0.741599, -11.32468, 236.1663,   0.0]]        # O2 else: if T < 2000: #           A         B          C
# D         E          F          G           H WB = [[35.15070,  1.300095,  -0.205921, 0.013550, -3.282780,
# -127.8375, 231.7120,  -110.5271],  # CO [41.96426,  8.622053,  -1.499780, 0.098119, -11.15764, -272.1797, 219.7809,
# -241.8264],  # H2O* [58.16639,  2.720074,  -0.492289, 0.038844, -6.447293, -425.9186, 263.6125,  -393.5224],
# CO2 [18.563083, 12.257357, -2.859786, 0.268238,  1.977990, -1.147438, 156.288133, 0.0],       # H2 [-0.703029,
# 108.4773,  -42.52157, 5.862788,  0.678565, -76.84376, 158.7163,  -74.87310],  # CH4 [30.03235,  8.772972,
# -3.988133, 0.788313, -0.741599, -11.32468, 236.1663,   0.0]]       # O2 else: if T < 2500: #           A         B
# C         D         E          F          G           H WB = [[35.15070,  1.300095,  -0.205921, 0.013550,
# -3.282780, -127.8375, 231.7120,  -110.5271],  # CO [41.96426,  8.622053,  -1.499780, 0.098119, -11.15764,
# -272.1797, 219.7809,  -241.8264],  # H2O [58.16639,  2.720074,  -0.492289, 0.038844, -6.447293, -425.9186,
# 263.6125,  -393.5224],  # CO2 [18.563083, 12.257357, -2.859786, 0.268238,  1.977990, -1.147438, 156.288133, 0.0],
# H2 [-0.703029, 108.4773,  -42.52157, 5.862788,  0.678565, -76.84376, 158.7163,  -74.87310],  # CH4 [20.91111,
# 10.72071,  -2.020498, 0.146449,  9.245722,  5.337651, 237.6185,   0.0]]       # O2* else: if T > 2500: #
# A         B          C         D         E          F          G           H WB = [[35.15070,   1.300095,
# -0.205921,  0.013550, -3.282780,  -127.8375,  231.7120,  -110.5271],  # CO [41.96426,   8.622053, -1.499780,
# 0.098119, -11.15764,  -272.1797,  219.7809,  -241.8264],  # H2O [58.16639,   2.720074, -0.492289,  0.038844,
# -6.447293,  -425.9186,  263.6125,  -393.5224],  # CO2 [43.413560, -4.293079,  1.272428, -0.096876, -20.533862,
# -38.515158, 162.081354, 0.0],       # H2* [-0.703029,  108.4773, -42.52157,  5.862788,  0.678565,  -76.84376,
# 158.7163,  -74.87310],  # CH4 [20.91111,   10.72071, -2.020498,  0.146449,  9.245722,   5.337651,  237.6185,
# 0.0]]       # O2


# Aeq = np.array([[1, 0, 1, 0, 1, 0],   # C balance
#                [1, 1, 2, 0, 0, 2],   # O balance
#                [0, 2, 0, 2, 4, 0]])  # H balance

# equimolar feed of 1 mol H2 and 1 mol O2


def minimization():
    def func(nj):
        return np.dot(np.array(nj), Gjo / (R * T) + np.log(np.array(nj) / np.sum(nj) * float(text_box2.text) / Po))

    def ec1(nj):
        # 'conservation of atoms constraint'
        if spinner1.text == "CH4":
            if spinner2.text == "O2(L)":
                aeq = np.array([[1, 0, 1, 0, 1, 0],  # C balance
                                [1, 1, 2, 0, 0, 2],  # O balance
                                [0, 2, 0, 2, 4, 0]])  # H balance
            else:
                aeq = np.array([[1, 0, 1, 0, 1, 0],  # C balance
                                [1, 1, 2, 0, 0, 2],  # O balance
                                [0, 2, 0, 2, 4, 0]])  # H balance
        else:
            if spinner1.text == "H2(L)":
                if spinner2.text == "O2(L)":
                    aeq = np.array([[0, 0, 0],  # C balance
                                    [1, 0, 2],  # O balance
                                    [2, 2, 0]])  # H balance
                else:
                    aeq = np.array([[0, 0, 0],  # C balance
                                    [1, 0, 2],  # O balance
                                    [2, 2, 0]])  # H balance
            else:
                aeq = np.array([[0, 0, 0],  # C balance
                                [1, 0, 2],  # O balance
                                [2, 2, 0]])  # H balance
        return np.dot(aeq, nj) - beq

    # define n0 -----------------------------------------------------
    def inicial():

        if spinner1.text == "CH4":
            if spinner2.text == "O2(L)":
                n0 = [0.5, 0.5, 0.5, 0.5, 0.5, 0.5]  # initial guesses
            else:
                n0 = [0.5, 0.5, 0.5, 0.5, 0.5, 0.5]
        else:
            if spinner1.text == "H2(L)":
                if spinner2.text == "O2(L)":
                    n0 = [0.9, 0.2, 0.2]  # initial guesses
                else:
                    n0 = [0.5, 0.5, 0.5, 0.5]
            else:
                n0 = [0.5, 0.5, 0.5, 0.5, 0.5, 0.5]
        return n0

    # define n0 -----------------------------------------------------
    T = 1000  # K
    Tantigo = 0
    while abs(T - Tantigo) > 20:
        Tantigo = T
        # define WB -----------------------------------------------------
        if spinner1.text == "H2(L)":
            if spinner2.text == "O2(L)":
                Hf298 = [
                    -241.826,  # H2O
                    0.0,  # H2
                    0.0]  # O2
                if T < 700:
                    #           A          B           C          D          E            F          G       H
                    WB = [[30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],  # H2O
                          [33.066178, -11.363417, 11.432816, -2.772874, -0.158558, -9.980797, 172.707974, 0.0],  # H2
                          [31.32234, -20.23531, 57.86644, -36.50624, -0.007374, -8.903471, 246.7945, 0.0]]  # O2
                else:
                    if T < 1000:
                        #           A          B           C          D          E         F         G          H
                        WB = [[30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],
                              # H2O
                              [33.066178, -11.363417, 11.432816, -2.772874, -0.158558, -9.980797, 172.707974, 0.0],
                              # H2
                              [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663, 0.0]]  # O2*
                    else:
                        if T < 1200:
                            #           A          B           C          D          E          F         G         H
                            WB = [
                                [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],
                                # H2O
                                [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438, 156.288133, 0.0],
                                # H2*
                                [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663, 0.0]]  # O2
                        else:
                            if T < 1300:
                                #           A         B          C         D         E          F          G           H
                                WB = [
                                    [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],
                                    # H2O
                                    [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438, 156.288133, 0.0],
                                    # H2
                                    [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663,
                                     0.0]]  # O2
                            else:
                                if T < 1700:
                                    # A         B          C         D         E          F          G           H
                                    WB = [
                                        [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967,
                                         -241.8264],
                                        # H2O
                                        [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438, 156.288133,
                                         0.0],
                                        # H2
                                        [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663,
                                         0.0]]  # O2
                                else:
                                    if T < 2000:
                                        # A         B          C         D         E          F          G           H
                                        WB = [[41.96426, 8.622053, -1.499780, 0.098119, -11.15764, -272.1797, 219.7809,
                                               -241.8264],  # H2O*
                                              [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438,
                                               156.288133,
                                               0.0],
                                              # H2
                                              [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663,
                                               0.0]]  # O2
                                    else:
                                        if T < 2500:
                                            # A      B          C         D         E          F          G           H
                                            WB = [[41.96426, 8.622053, -1.499780, 0.098119, -11.15764, -272.1797,
                                                   219.7809,
                                                   -241.8264],  # H2O
                                                  [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438,
                                                   156.288133,
                                                   0.0],  # H2
                                                  [20.91111, 10.72071, -2.020498, 0.146449, 9.245722, 5.337651,
                                                   237.6185,
                                                   0.0]]  # O2*
                                        else:
                                            # A    B          C         D         E          F          G           H
                                            WB = [[41.96426, 8.622053, -1.499780, 0.098119, -11.15764, -272.1797,
                                                   219.7809,
                                                   -241.8264],  # H2O
                                                  [43.413560, -4.293079, 1.272428, -0.096876, -20.533862, -38.515158,
                                                   162.081354, 0.0],  # H2*
                                                  [20.91111, 10.72071, -2.020498, 0.146449, 9.245722, 5.337651,
                                                   237.6185,
                                                   0.0]]  # O2
            else:
                Hf298 = [
                    -241.826,  # H2O
                    0.0,  # H2
                    0.0]  # O2
                if T < 700:
                    #           A          B           C          D          E            F          G       H
                    WB = [[30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],  # H2O
                          [33.066178, -11.363417, 11.432816, -2.772874, -0.158558, -9.980797, 172.707974, 0.0],  # H2
                          [31.32234, -20.23531, 57.86644, -36.50624, -0.007374, -8.903471, 246.7945, 0.0]]  # O2
                else:
                    if T < 1000:
                        #           A          B           C          D          E         F         G          H
                        WB = [[30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],
                              # H2O
                              [33.066178, -11.363417, 11.432816, -2.772874, -0.158558, -9.980797, 172.707974, 0.0],
                              # H2
                              [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663, 0.0]]  # O2*
                    else:
                        if T < 1200:
                            #           A          B           C          D          E          F         G         H
                            WB = [
                                [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],
                                # H2O
                                [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438, 156.288133, 0.0],
                                # H2*
                                [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663, 0.0]]  # O2
                        else:
                            if T < 1300:
                                #           A         B          C         D         E          F          G           H
                                WB = [
                                    [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],
                                    # H2O
                                    [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438, 156.288133, 0.0],
                                    # H2
                                    [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663,
                                     0.0]]  # O2
                            else:
                                if T < 1700:
                                    #     A         B          C         D         E          F          G           H
                                    WB = [
                                        [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967,
                                         -241.8264],
                                        # H2O
                                        [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438, 156.288133,
                                         0.0],
                                        # H2
                                        [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663,
                                         0.0]]  # O2
                                else:
                                    if T < 2000:
                                        # A         B          C         D         E          F          G           H
                                        WB = [[41.96426, 8.622053, -1.499780, 0.098119, -11.15764, -272.1797, 219.7809,
                                               -241.8264],  # H2O*
                                              [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438,
                                               156.288133,
                                               0.0],
                                              # H2
                                              [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663,
                                               0.0]]  # O2
                                    else:
                                        if T < 2500:
                                            # A     B          C         D         E          F          G           H
                                            WB = [[41.96426, 8.622053, -1.499780, 0.098119, -11.15764, -272.1797,
                                                   219.7809,
                                                   -241.8264],  # H2O
                                                  [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438,
                                                   156.288133,
                                                   0.0],  # H2
                                                  [20.91111, 10.72071, -2.020498, 0.146449, 9.245722, 5.337651,
                                                   237.6185,
                                                   0.0]]  # O2*
                                        else:
                                            # A    B          C         D         E          F          G           H
                                            WB = [[41.96426, 8.622053, -1.499780, 0.098119, -11.15764, -272.1797,
                                                   219.7809,
                                                   -241.8264],  # H2O
                                                  [43.413560, -4.293079, 1.272428, -0.096876, -20.533862, -38.515158,
                                                   162.081354, 0.0],  # H2*
                                                  [20.91111, 10.72071, -2.020498, 0.146449, 9.245722, 5.337651,
                                                   237.6185,
                                                   0.0]]  # O2
        else:
            if spinner1.text == "CH4":
                if spinner2.text == "O2(L)":
                    Hf298 = [
                        -110.53,  # CO
                        -241.826,  # H2O
                        -393.51,  # CO2
                        0.0,  # H2
                        -74.87310,  # CH4
                        0.0]  # O2
                    if T < 700:
                        #           A          B           C          D          E            F          G       H
                        WB = [[25.56759, 6.096130, 4.054656, -2.671301, 0.131021, -118.0089, 227.3665, -110.5271],  # CO
                              [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],
                              # H2O
                              [24.99735, 55.18696, -33.69137, 7.948387, -0.136638, -403.6075, 228.2431, -393.5224],
                              # CO2
                              [33.066178, -11.363417, 11.432816, -2.772874, -0.158558, -9.980797, 172.707974, 0.0],
                              # H2
                              [-0.703029, 108.4773, -42.52157, 5.862788, 0.678565, -76.84376, 158.7163, -74.87310],
                              # CH4
                              [31.32234, -20.23531, 57.86644, -36.50624, -0.007374, -8.903471, 246.7945, 0.0]]  # O2
                    else:
                        if T < 1000:
                            #           A          B           C          D          E         F         G          H
                            WB = [[25.56759, 6.096130, 4.054656, -2.671301, 0.131021, -118.0089, 227.3665, -110.5271],
                                  # CO
                                  [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],
                                  # H2O
                                  [24.99735, 55.18696, -33.69137, 7.948387, -0.136638, -403.6075, 228.2431, -393.5224],
                                  # CO2
                                  [33.066178, -11.363417, 11.432816, -2.772874, -0.158558, -9.980797, 172.707974, 0.0],
                                  # H2
                                  [-0.703029, 108.4773, -42.52157, 5.862788, 0.678565, -76.84376, 158.7163, -74.87310],
                                  # CH4
                                  [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663, 0.0]]  # O2*
                        else:
                            if T < 1200:
                                #       A          B           C          D          E          F         G         H
                                WB = [
                                    [25.56759, 6.096130, 4.054656, -2.671301, 0.131021, -118.0089, 227.3665, -110.5271],
                                    # CO
                                    [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],
                                    # H2O
                                    [24.99735, 55.18696, -33.69137, 7.948387, -0.136638, -403.6075, 228.2431,
                                     -393.5224],
                                    # CO2
                                    [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438, 156.288133, 0.0],
                                    # H2*
                                    [-0.703029, 108.4773, -42.52157, 5.862788, 0.678565, -76.84376, 158.7163,
                                     -74.87310],
                                    # CH4
                                    [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663,
                                     0.0]]  # O2
                            else:
                                if T < 1300:
                                    #     A         B          C         D         E          F          G           H
                                    WB = [
                                        [25.56759, 6.096130, 4.054656, -2.671301, 0.131021, -118.0089, 227.3665,
                                         -110.5271],
                                        # CO
                                        [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967,
                                         -241.8264],
                                        # H2O
                                        [58.16639, 2.720074, -0.492289, 0.038844, -6.447293, -425.9186, 263.6125,
                                         -393.5224],
                                        # CO2*
                                        [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438, 156.288133,
                                         0.0],
                                        # H2
                                        [-0.703029, 108.4773, -42.52157, 5.862788, 0.678565, -76.84376, 158.7163,
                                         -74.87310],
                                        # CH4
                                        [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663,
                                         0.0]]  # O2
                                else:
                                    if T < 1700:
                                        # A         B          C         D         E          F          G           H
                                        WB = [[35.15070, 1.300095, -0.205921, 0.013550, -3.282780, -127.8375, 231.7120,
                                               -110.5271],
                                              # CO*
                                              [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967,
                                               -241.8264],
                                              # H2O
                                              [58.16639, 2.720074, -0.492289, 0.038844, -6.447293, -425.9186, 263.6125,
                                               -393.5224],
                                              # CO2
                                              [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438,
                                               156.288133,
                                               0.0],
                                              # H2
                                              [-0.703029, 108.4773, -42.52157, 5.862788, 0.678565, -76.84376, 158.7163,
                                               -74.87310],
                                              # CH4
                                              [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663,
                                               0.0]]  # O2
                                    else:
                                        if T < 2000:
                                            #   A    B          C         D         E          F          G           H
                                            WB = [[35.15070, 1.300095, -0.205921, 0.013550, -3.282780, -127.8375,
                                                   231.7120,
                                                   -110.5271],  # CO
                                                  [41.96426, 8.622053, -1.499780, 0.098119, -11.15764, -272.1797,
                                                   219.7809,
                                                   -241.8264],  # H2O*
                                                  [58.16639, 2.720074, -0.492289, 0.038844, -6.447293, -425.9186,
                                                   263.6125,
                                                   -393.5224],  # CO2
                                                  [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438,
                                                   156.288133,
                                                   0.0],
                                                  # H2
                                                  [-0.703029, 108.4773, -42.52157, 5.862788, 0.678565, -76.84376,
                                                   158.7163,
                                                   -74.87310],  # CH4
                                                  [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468,
                                                   236.1663,
                                                   0.0]]  # O2
                                        else:
                                            if T < 2500:
                                                # A      B    C         D         E          F          G           H
                                                WB = [[35.15070, 1.300095, -0.205921, 0.013550, -3.282780, -127.8375,
                                                       231.7120,
                                                       -110.5271],  # CO
                                                      [41.96426, 8.622053, -1.499780, 0.098119, -11.15764, -272.1797,
                                                       219.7809,
                                                       -241.8264],  # H2O
                                                      [58.16639, 2.720074, -0.492289, 0.038844, -6.447293, -425.9186,
                                                       263.6125,
                                                       -393.5224],  # CO2
                                                      [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438,
                                                       156.288133,
                                                       0.0],  # H2
                                                      [-0.703029, 108.4773, -42.52157, 5.862788, 0.678565, -76.84376,
                                                       158.7163,
                                                       -74.87310],  # CH4
                                                      [20.91111, 10.72071, -2.020498, 0.146449, 9.245722, 5.337651,
                                                       237.6185,
                                                       0.0]]  # O2*
                                            else:
                                                #  A     B    C        D         E          F          G           H
                                                WB = [[35.15070, 1.300095, -0.205921, 0.013550, -3.282780, -127.8375,
                                                       231.7120,
                                                       -110.5271],  # CO
                                                      [41.96426, 8.622053, -1.499780, 0.098119, -11.15764, -272.1797,
                                                       219.7809,
                                                       -241.8264],  # H2O
                                                      [58.16639, 2.720074, -0.492289, 0.038844, -6.447293, -425.9186,
                                                       263.6125,
                                                       -393.5224],  # CO2
                                                      [43.413560, -4.293079, 1.272428, -0.096876, -20.533862,
                                                       -38.515158,
                                                       162.081354, 0.0],  # H2*
                                                      [-0.703029, 108.4773, -42.52157, 5.862788, 0.678565, -76.84376,
                                                       158.7163,
                                                       -74.87310],  # CH4
                                                      [20.91111, 10.72071, -2.020498, 0.146449, 9.245722, 5.337651,
                                                       237.6185,
                                                       0.0]]  # O2
                else:
                    Hf298 = [
                        -241.826,  # H2O
                        0.0,  # H2
                        0.0]  # O2
                    if T < 700:
                        #           A          B           C          D          E            F          G       H
                        WB = [[30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],
                              # H2O
                              [33.066178, -11.363417, 11.432816, -2.772874, -0.158558, -9.980797, 172.707974, 0.0],
                              # H2
                              [31.32234, -20.23531, 57.86644, -36.50624, -0.007374, -8.903471, 246.7945, 0.0]]  # O2
                    else:
                        if T < 1000:
                            #           A          B           C          D          E         F         G          H
                            WB = [[30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],
                                  # H2O
                                  [33.066178, -11.363417, 11.432816, -2.772874, -0.158558, -9.980797, 172.707974, 0.0],
                                  # H2
                                  [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663, 0.0]]  # O2*
                        else:
                            if T < 1200:
                                #     A          B           C          D          E          F         G         H
                                WB = [
                                    [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967, -241.8264],
                                    # H2O
                                    [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438, 156.288133, 0.0],
                                    # H2*
                                    [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663,
                                     0.0]]  # O2
                            else:
                                if T < 1300:
                                    #    A         B          C         D         E          F          G           H
                                    WB = [
                                        [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967,
                                         -241.8264],
                                        # H2O
                                        [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438, 156.288133,
                                         0.0],
                                        # H2
                                        [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663,
                                         0.0]]  # O2
                                else:
                                    if T < 1700:
                                        # A         B          C         D         E          F          G           H
                                        WB = [
                                            [30.09200, 6.832514, 6.793435, -2.534480, 0.082139, -250.8810, 223.3967,
                                             -241.8264],
                                            # H2O
                                            [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438, 156.288133,
                                             0.0],
                                            # H2
                                            [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468, 236.1663,
                                             0.0]]  # O2
                                    else:
                                        if T < 2000:
                                            # A    B       C         D         E          F          G           H
                                            WB = [[41.96426, 8.622053, -1.499780, 0.098119, -11.15764, -272.1797,
                                                   219.7809,
                                                   -241.8264],  # H2O*
                                                  [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438,
                                                   156.288133,
                                                   0.0],
                                                  # H2
                                                  [30.03235, 8.772972, -3.988133, 0.788313, -0.741599, -11.32468,
                                                   236.1663,
                                                   0.0]]  # O2
                                        else:
                                            if T < 2500:
                                                # A         B          C         D         E          F          G
                                                # H
                                                WB = [[41.96426, 8.622053, -1.499780, 0.098119, -11.15764, -272.1797,
                                                       219.7809,
                                                       -241.8264],  # H2O
                                                      [18.563083, 12.257357, -2.859786, 0.268238, 1.977990, -1.147438,
                                                       156.288133,
                                                       0.0],  # H2
                                                      [20.91111, 10.72071, -2.020498, 0.146449, 9.245722, 5.337651,
                                                       237.6185,
                                                       0.0]]  # O2*
                                            else:
                                                # A    B      C       D         E          F          G           H
                                                WB = [[41.96426, 8.622053, -1.499780, 0.098119, -11.15764, -272.1797,
                                                       219.7809,
                                                       -241.8264],  # H2O
                                                      [43.413560, -4.293079, 1.272428, -0.096876, -20.533862,
                                                       -38.515158,
                                                       162.081354, 0.0],  # H2*
                                                      [20.91111, 10.72071, -2.020498, 0.146449, 9.245722, 5.337651,
                                                       237.6185,
                                                       0.0]]  # O2
            else:
                Hf298 = [
                    -241.826,  # H2O
                    0.0,  # H2
                    0.0]  # O2
                WB = [0]
        WB = np.array(WB)
        # defines WB -----------------------------------------------------

        # defines beq ----------------------------------------------------
        if spinner1.text == "H2(L)":
            fuel = np.array([0,  # mol C fed
                             0,  # mol O fed
                             2])  # mol H fed
        else:
            if spinner1.text == "CH4":
                fuel = np.array([1,  # mol C fed
                                 0,  # mol O fed
                                 4])  # mol H fed
            else:
                fuel = np.array([0,  # mol C fed
                                 0,  # mol O fed
                                 0])  # mol H fed
        if spinner2.text == "O2(L)":
            oxi = np.array([0,  # mol C fed
                            2,  # mol O fed
                            0])  # mol H fed
        else:
            if spinner2.text == "N2O":
                oxi = np.array([0,  # mol C fed
                                2,  # mol O fed
                                0])  # mol H fed
            else:
                oxi = np.array([0,  # mol C fed
                                0,  # mol O fed
                                0])  # mol H fed

        beq = fuel * float(text_box3.text) + oxi * float(text_box4.text)
        # defines beq -----------------------------------------------------

        # Shomate equations ----------------------------------------------- https://webbook.nist.gov/chemistry/name-ser/
        t = T / 1000
        T_H = np.array([t, t ** 2 / 2.0, t ** 3 / 3.0, t ** 4 / 4.0, -1.0 / t, 1.0, 0.0, -1.0])
        T_S = np.array([np.log(t), t, t ** 2 / 2.0, t ** 3 / 3.0, -1.0 / (2.0 * t ** 2), 0.0, 1.0, 0.0])
        C_P = np.array([1, t, t ** 2, t ** 3, 1 / (t ** 2), 0.0, 0.0, 0.0])

        H = np.dot(WB, T_H)  # (H - H_298.15) kJ/mol
        S = np.dot(WB, T_S / 1000.0)  # absolute entropy kJ/mol/K

        Gjo = Hf298 + H - T * S  # Gibbs energy of each component at 1000 K
        # Shomate equations -----------------------------------------------

        # minimization ----------------------------------------------------
        N = fmin_slsqp(func, inicial(), f_eqcons=ec1)
        # minimization ----------------------------------------------------

        # saida -----------------------------------------------------------
        print(N)
        if spinner1.text == "CH4":
            nTotal = np.sum(N)
            text_box1.text = "Mole fraction:" + "\nCO:   " + str(N[0] / nTotal) + "\nH2O: " + str(
                N[1] / nTotal) + "\nCO2: " + str(N[2] / nTotal) + "\nH2:   " + str(N[3]/ nTotal) + "\nCH4: " +\
                             str(N[4] / nTotal) + "\nO2:   " + str(N[5] / nTotal) + "\nTemperature:" + str(T)
        if spinner1.text == "H2(L)":
            nTotal = np.sum(N)
            text_box1.text = "Mole fraction:" + "\nH2O: " + str(N[0] / nTotal) + "\nH2:   " + str(
                N[1] / nTotal) + "\nO2:   " + str(N[2] / nTotal) + "\nTemperature:" + str(T)  + "\nWORK IN PROGRESS"
        # saida -----------------------------------------------------------

        # correção da temperatura -----------------------------------------
        Q = np.transpose(C_P * WB) * (T - 298) * N
        Q = np.sum(Q) / 1000
        if spinner1.text == "H2(L)":
            Hreac = 0.0  # H2
            Hreac -= -241.8264  # H2O
        else:
            if spinner1.text == "CH4":
                Hreac = -74.87310  # CH4
                Hreac -= -241.8264  # H2O
                Hreac -= -110.5271  # CO
                Hreac -= -393.5224  # CO2
            else:
                Hreac = 0.0
        if spinner2.text == "O2(L)":
            Hreac += 0.0
        else:
            if spinner2.text == "N2O":
                Hreac += 82.04824
            else:
                Hreac += 0.0
        if abs(Q - Hreac) < 0.1:
            Tantigo=T
        else:
            if Q < Hreac:
                T = T * 1.01 + 100
            else:
                if Q > Hreac:
                    T = T - 33

        # correção da temperatura -----------------------------------------


b1 = Button(size_hint=(.2, .1),
            pos_hint={'top': .5, 'right': .6},
            text="Solve",
            on_release=lambda x: minimization())


class Main(App):
    def build(self):
        Window.size = (450, 800)
        bl = AnchorLayout()

        fl1 = FloatLayout()
        fl2 = FloatLayout()
        fl3 = FloatLayout()
        fl4 = FloatLayout()
        fl5 = FloatLayout()
        fl6 = FloatLayout()
        fl7 = FloatLayout()
        fl8 = FloatLayout()
        fl9 = FloatLayout()
        fl10 = FloatLayout()
        fl11 = FloatLayout()
        # fl12 = FloatLayout()
        # fl13 = FloatLayout()
        # fl14 = FloatLayout()
        # fl15 = FloatLayout()

        fl1.add_widget(lab1)
        fl2.add_widget(text_box1)
        fl3.add_widget(spinner1)
        fl4.add_widget(spinner2)
        fl5.add_widget(b1)
        fl6.add_widget(text_box2)
        fl7.add_widget(lab2)
        fl8.add_widget(lab3)
        fl9.add_widget(lab4)
        fl10.add_widget(text_box3)
        fl11.add_widget(text_box4)

        bl.add_widget(fl1)
        bl.add_widget(fl2)
        bl.add_widget(fl3)
        bl.add_widget(fl4)
        bl.add_widget(fl5)
        bl.add_widget(fl6)
        bl.add_widget(fl7)
        bl.add_widget(fl8)
        bl.add_widget(fl9)
        bl.add_widget(fl10)
        bl.add_widget(fl11)
        #     bl.add_widget(fl12)
        #     bl.add_widget(fl13)
        #     bl.add_widget(fl14)
        #     bl.add_widget(fl15)

        return bl


if __name__ == "__main__":
    Main().run()
